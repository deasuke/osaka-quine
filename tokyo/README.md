# 山手線バージョン

山手線で作り直したものです。

## 使い方
使用法は本家と同じ。フォントが綺麗になった分、大きくなっています。
```bash
% ruby tokyo.rb | ruby | ruby ...
```
とすると順に内回り
```bash
% ruby tokyo.rb x | ruby - x | ruby - x ...
```
とすると順に外回り

## 大阪の反省を生かした点や違いなど

1. 駅名ループの使用文字
大阪環状線の駅名の使用文字は35種類だが、山手線の駅名の使用文字は54種類。従ってそのまま駅名の最後にくるものと来ないものの区別を付けると108種となり、表示可能文字の個数を越えてしまう。そこで、駅名の最後に来る文字は22種であることを利用し、駅名の最後は`e-z`を、最後以外は`#-X`を利用した。前者を54で割った余りは0〜14または47〜53となるので駅名の最後にくる可能性のある文字はこの範囲に来るように配置した。 例えば「田」の場合、駅名の最後に来る場合は`n`となり、最後以外の場合は`8`となる。何れにしてもASCIIコードを54で割ると余りが2となり、インデックス2を利用してフォント情報を参照する。

2. 圧縮率最大の配置を検索
先の条件を満す漢字の配置は無数にあるので、絨毯爆撃(大域的な乱数順列)と局所探索(局所的な乱数順列)を組合せて圧縮率が最大となる配置を探索した。無作為のものと比較して200ビットくらいは小さくなった。

3. 90進数を利用
91進数を利用するのはやめて`{|}`を利用しない90進数を用いた。使用範囲は本家の`!-[`と`]-z`に加えて`~`の90文字である。文字のASCIIコードを`i`とするとき、`i%124%90`とするだけでこれらの文字が巧く`0-89`の範囲に治まる。`~`が丁度`\`の場所を埋めてくれるのである。

4. 本家で用いていたテクニックの採用
メソッドの最後で自分自身を返すことにより、`g[][][][]`のような形でメソッド`g`を何度も呼べる。また、`g[][][something]`の方が`g[][][];something`より1文字短いので`->`を`proc`にすることで引数の個数を可変とした。しかし`g[][][something]`は2度しか登場していないのでタイである。

5. 最悪条件の駅から調整
隙間となる空白部分の多い漢字の2文字の駅が最悪である。調査をすると巣鴨がそれに当るので、巣鴨を中心に調整したので、調整は楽に済んだ。

## 感想
本家のフォントがショボいのには訳があるんだな、と思いました。